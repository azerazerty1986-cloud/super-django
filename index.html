<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نكهة وجمال | ناردو برو - المتجر الذكي المتكامل 2026</title>
    
    <!-- Google Fonts - Cairo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Chart.js للرسوم البيانية -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Swiper للمعرض -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    
    <style>
        /* ===== المتغيرات العامة ===== */
        :root {
            --bg-primary: #0a1a15;
            --bg-secondary: #1a2f28;
            --bg-card: rgba(26, 47, 40, 0.95);
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;
            --gold: #d4af37;
            --gold-dark: #b38f2c;
            --gold-light: #f4e3b1;
            --nardoo: #2c5e4f;
            --nardoo-dark: #1a3a32;
            --nardoo-light: #3e826b;
            --purple: #9b59b6;
            --purple-dark: #8e44ad;
            --blue: #3498db;
            --blue-dark: #2980b9;
            --red: #e74c3c;
            --red-dark: #c0392b;
            --green: #25D366;
            --green-dark: #128C7E;
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            --shadow-gold: 0 10px 30px rgba(212, 175, 55, 0.3);
            --transition: all 0.3s ease;
        }

        body.light-mode {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-card: rgba(255, 255, 255, 0.95);
            --text-primary: #2c3e50;
            --text-secondary: #34495e;
            --glass: rgba(0, 0, 0, 0.03);
            --glass-border: rgba(0, 0, 0, 0.1);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: var(--transition);
            min-height: 100vh;
        }

        .container {
            width: 95%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* ===== شاشة التحميل ===== */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }

        .loader-spinner {
            width: 80px;
            height: 80px;
            border: 5px solid var(--gold);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== نظام الإشعارات ===== */
        .notification-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .notification {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 2px solid var(--gold);
            border-radius: 50px;
            padding: 15px 30px;
            color: var(--text-primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow);
            animation: slideIn 0.3s ease, slideOut 0.3s ease 2.7s forwards;
            pointer-events: auto;
            min-width: 300px;
            border-right: 10px solid;
        }

        .notification.success { border-right-color: #4ade80; }
        .notification.error { border-right-color: #f87171; }
        .notification.warning { border-right-color: #fbbf24; }
        .notification.info { border-right-color: #60a5fa; }

        @keyframes slideIn {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-100%); opacity: 0; }
        }

        /* ===== الهيدر ===== */
        .top-bar {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--gold);
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .top-bar .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .top-bar-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .top-bar-item i {
            color: var(--gold);
        }

        .theme-toggle {
            background: var(--glass);
            border: 1px solid var(--gold);
            border-radius: 50px;
            padding: 5px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: var(--gold);
            color: var(--bg-primary);
        }

        /* ===== الهيدر الرئيسي ===== */
        .main-header {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--gold);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: rotate(-5deg);
            transition: var(--transition);
            box-shadow: var(--shadow-gold);
        }

        .logo:hover .logo-icon {
            transform: rotate(0deg) scale(1.1);
        }

        .logo-icon i {
            font-size: 30px;
            color: var(--bg-primary);
        }

        .logo-text h1 {
            font-size: 32px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 50%, var(--gold) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }

        .logo-text span {
            color: var(--gold-light);
            font-size: 14px;
            font-weight: 600;
        }

        /* ===== البحث ===== */
        .search-wrapper {
            flex: 0 1 400px;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: var(--glass);
            border: 2px solid var(--glass-border);
            border-radius: 50px;
            padding: 5px 5px 5px 20px;
            transition: var(--transition);
        }

        .search-box:focus-within {
            border-color: var(--gold);
            box-shadow: 0 0 20px var(--gold);
        }

        .search-box input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 12px 0;
            color: var(--text-primary);
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            outline: none;
        }

        .search-box input::placeholder {
            color: var(--text-secondary);
            opacity: 0.5;
        }

        .search-box button {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--gold);
            border: none;
            color: var(--bg-primary);
            cursor: pointer;
            transition: var(--transition);
            font-size: 18px;
        }

        .search-box button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--gold);
        }

        /* ===== أزرار الإجراءات ===== */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .action-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--gold);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            position: relative;
        }

        .action-btn:hover {
            background: var(--gold);
            color: var(--bg-primary);
            transform: translateY(-3px);
            border-color: var(--gold);
        }

        .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--gold);
            color: var(--bg-primary);
            font-size: 12px;
            font-weight: 700;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ===== القائمة الرئيسية ===== */
        .nav-menu {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            backdrop-filter: blur(10px);
            border-radius: 60px;
            padding: 15px 25px;
            margin: 20px 0;
            border: 2px solid var(--gold);
            box-shadow: var(--shadow-gold);
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 25px;
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 700;
            border-radius: 40px;
            transition: var(--transition);
            cursor: pointer;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: var(--gold);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: -1;
        }

        .nav-link:hover::before {
            transform: translateX(0);
        }

        .nav-link:hover {
            color: var(--bg-primary);
        }

        .nav-link:hover i {
            color: var(--bg-primary);
            transform: scale(1.1);
        }

        .nav-link.active {
            background: var(--gold);
            color: var(--bg-primary);
            box-shadow: 0 0 20px var(--gold);
        }

        .nav-link.active i {
            color: var(--bg-primary);
        }

        .nav-link i {
            color: var(--gold);
            transition: var(--transition);
            font-size: 16px;
        }

        /* ===== لوحة التاجر ===== */
        .merchant-panel {
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            border-radius: 30px;
            padding: 25px;
            margin: 20px 0;
            color: white;
            box-shadow: 0 10px 30px rgba(155, 89, 182, 0.3);
            border: 2px solid var(--gold);
        }

        .merchant-panel h3 {
            color: white;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .merchant-panel .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .merchant-panel .stat-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .merchant-panel .stat-item .number {
            font-size: 28px;
            font-weight: 800;
            color: var(--gold);
        }

        /* ===== الفلاتر ===== */
        .filters-section {
            margin: 30px 0;
        }

        .categories-filter {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
        }

        .category-btn {
            padding: 12px 28px;
            background: var(--glass);
            border: 2px solid transparent;
            border-radius: 40px;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 700;
            font-size: 15px;
            position: relative;
            overflow: hidden;
        }

        .category-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .category-btn:hover {
            border-color: var(--gold);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
        }

        .category-btn.active {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--bg-primary);
            border-color: var(--gold);
            box-shadow: 0 0 20px var(--gold);
        }

        /* ===== المنتجات - شبكة 3 أعمدة ===== */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin: 30px 0;
        }

        @media (max-width: 1200px) {
            .products-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 992px) {
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 576px) {
            .products-grid {
                grid-template-columns: 1fr;
            }
        }

        .product-card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            overflow: hidden;
            transition: var(--transition);
            position: relative;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }

        .product-card:hover {
            transform: translateY(-10px);
            border-color: var(--gold);
            box-shadow: var(--shadow-gold);
        }

        .product-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--bg-primary);
            padding: 5px 15px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 700;
            z-index: 2;
            box-shadow: 0 0 15px var(--gold);
        }

        .merchant-badge {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            color: white;
            padding: 5px 12px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 700;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 0 15px var(--purple);
        }

        /* ===== معرض الصور للمنتج ===== */
        .product-gallery {
            position: relative;
            width: 100%;
            height: 250px;
            overflow: hidden;
        }

        .swiper {
            width: 100%;
            height: 100%;
        }

        .swiper-slide {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--nardoo-dark), var(--nardoo));
        }

        .swiper-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .swiper-pagination-bullet {
            background: var(--gold);
            width: 8px;
            height: 8px;
            opacity: 0.7;
        }

        .swiper-pagination-bullet-active {
            background: var(--gold);
            opacity: 1;
            width: 20px;
            border-radius: 10px;
        }

        .swiper-button-next,
        .swiper-button-prev {
            color: var(--gold);
            background: rgba(0, 0, 0, 0.5);
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }

        .swiper-button-next:after,
        .swiper-button-prev:after {
            font-size: 14px;
        }

        .product-info {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .product-category {
            color: var(--gold);
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .product-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-primary);
            line-height: 1.4;
            height: 44px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .product-price {
            font-size: 24px;
            font-weight: 800;
            color: var(--gold);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .product-price small {
            font-size: 14px;
            color: var(--gold-light);
            font-weight: 400;
        }

        .product-stock {
            font-size: 13px;
            margin-bottom: 15px;
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
            align-self: flex-start;
            font-weight: 600;
        }

        .in-stock {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            border: 1px solid #4ade80;
        }

        .low-stock {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }

        .out-of-stock {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
            border: 1px solid #f87171;
        }

        .product-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        .add-to-cart {
            flex: 2;
            padding: 12px;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            border: none;
            border-radius: 25px;
            color: var(--bg-primary);
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
        }

        .add-to-cart:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 0 20px var(--gold);
        }

        .add-to-cart:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .wishlist-btn {
            flex: 1;
            padding: 12px;
            background: var(--glass);
            border: 1px solid var(--gold);
            border-radius: 25px;
            color: var(--gold);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
        }

        .wishlist-btn:hover {
            background: var(--gold);
            color: var(--bg-primary);
            transform: scale(1.05);
        }

        /* ===== قسم العروض ===== */
        .promo-section {
            margin: 40px 0;
            position: relative;
        }

        .promo-banner {
            background: linear-gradient(135deg, #ff6b6b, #ff8787);
            border-radius: 30px;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
        }

        .promo-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .promo-banner h2 {
            font-size: 36px;
            font-weight: 900;
            color: white;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .promo-banner p {
            font-size: 18px;
            color: white;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .promo-banner .promo-code {
            background: rgba(255,255,255,0.2);
            padding: 15px 30px;
            border-radius: 50px;
            display: inline-block;
            font-size: 24px;
            font-weight: 800;
            color: white;
            border: 2px dashed white;
            letter-spacing: 2px;
        }

        /* ===== سلة التسوق الجانبية ===== */
        .cart-sidebar {
            position: fixed;
            top: 0;
            left: -400px;
            width: 400px;
            height: 100vh;
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            border-left: 2px solid var(--gold);
            z-index: 2000;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .cart-sidebar.open {
            left: 0;
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--gold);
            margin-bottom: 20px;
        }

        .cart-header h3 {
            color: var(--gold);
            font-size: 24px;
        }

        .close-cart {
            color: var(--gold);
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-cart:hover {
            transform: scale(1.2);
            color: var(--gold-light);
        }

        .cart-items {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .cart-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: var(--glass);
            border-radius: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--glass-border);
        }

        .cart-item-image {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            background: var(--nardoo);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cart-item-image i {
            font-size: 30px;
            color: var(--gold);
        }

        .cart-item-details {
            flex: 1;
        }

        .cart-item-title {
            font-weight: 700;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .cart-item-price {
            color: var(--gold);
            font-size: 14px;
        }

        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 10px;
            background: var(--glass);
            border: 1px solid var(--gold);
            color: var(--gold);
            cursor: pointer;
            transition: var(--transition);
        }

        .quantity-btn:hover {
            background: var(--gold);
            color: var(--bg-primary);
        }

        .cart-footer {
            border-top: 2px solid var(--gold);
            padding-top: 20px;
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            color: var(--gold);
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 20px;
        }

        .checkout-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--green), var(--green-dark));
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: 800;
            font-size: 18px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .checkout-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 0 30px var(--green);
        }

        /* ===== لوحة التحكم (للمدير فقط) ===== */
        .dashboard-section {
            margin: 40px 0;
        }

        .dashboard-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .dashboard-tab {
            padding: 12px 25px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 40px;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        .dashboard-tab:hover,
        .dashboard-tab.active {
            background: var(--gold);
            color: var(--bg-primary);
            border-color: var(--gold);
        }

        .dashboard-content {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--glass);
            border: 1px solid var(--gold);
            border-radius: 30px;
            padding: 25px;
            text-align: center;
        }

        .stat-card i {
            font-size: 40px;
            color: var(--gold);
            margin-bottom: 15px;
        }

        .stat-card .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--gold);
        }

        .stat-card .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .chart-container {
            height: 400px;
            margin: 30px 0;
        }

        /* ===== نموذج إضافة منتج ===== */
        .product-form {
            display: grid;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: var(--gold);
        }

        .form-control {
            padding: 15px;
            background: var(--glass);
            border: 2px solid var(--glass-border);
            border-radius: 20px;
            color: var(--text-primary);
            font-family: 'Cairo', sans-serif;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--gold);
            outline: none;
        }

        .form-control:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .image-upload-area {
            border: 2px dashed var(--gold);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .image-upload-area:hover {
            background: var(--glass);
        }

        .image-upload-area i {
            font-size: 40px;
            color: var(--gold);
            margin-bottom: 10px;
        }

        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .preview-image {
            width: 100px;
            height: 100px;
            border-radius: 15px;
            object-fit: cover;
            border: 2px solid var(--gold);
        }

        /* ===== النوافذ المنبثقة ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 2px solid var(--gold);
            border-radius: 30px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        .modal-lg {
            max-width: 1000px;
        }

        /* ===== الفوتر ===== */
        .footer {
            background: var(--bg-secondary);
            padding: 60px 0 30px;
            margin-top: 60px;
            border-top: 3px solid var(--gold);
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 40px;
            margin-bottom: 40px;
        }

        .footer-col h3 {
            color: var(--gold);
            font-size: 20px;
            margin-bottom: 20px;
        }

        .footer-col p {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .footer-col i {
            color: var(--gold);
            width: 20px;
        }

        .copyright {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid var(--gold-dark);
        }

        /* ===== جداول ===== */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            padding: 15px 10px;
            text-align: right;
            border-bottom: 2px solid var(--gold);
            color: var(--gold);
            font-weight: 700;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--glass-border);
        }

        /* ===== تأثيرات إضافية ===== */
        .glow-text {
            text-shadow: 0 0 10px var(--gold);
        }

        .btn-gold {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--bg-primary);
            border: none;
            padding: 12px 30px;
            border-radius: 40px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-gold:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px var(--gold);
        }

        .btn-outline-gold {
            background: transparent;
            border: 2px solid var(--gold);
            color: var(--gold);
            padding: 10px 25px;
            border-radius: 40px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-outline-gold:hover {
            background: var(--gold);
            color: var(--bg-primary);
        }

        .admin-only {
            display: block;
        }

        .merchant-only {
            display: block;
        }
    </style>
</head>
<body>
    <!-- شاشة التحميل -->
    <div class="loader" id="loader">
        <div class="loader-spinner"></div>
    </div>

    <!-- نظام الإشعارات -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- سلة التسوق الجانبية -->
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <h3><i class="fas fa-shopping-cart"></i> سلة التسوق</h3>
            <i class="fas fa-times close-cart" onclick="toggleCart()"></i>
        </div>
        <div class="cart-items" id="cartItems"></div>
        <div class="cart-footer">
            <div class="cart-total">
                <span>المجموع:</span>
                <span id="cartTotal">0 دج</span>
            </div>
            <button class="checkout-btn" onclick="checkoutCart()">
                <i class="fab fa-whatsapp"></i> إتمام الطلب عبر واتساب
            </button>
        </div>
    </div>

    <!-- الشريط العلوي -->
    <div class="top-bar">
        <div class="container">
            <div class="top-bar-item">
                <i class="fas fa-truck-fast"></i>
                <span>شحن مجاني للطلبات فوق 5000 دج</span>
            </div>
            <div class="top-bar-item">
                <i class="fas fa-headset"></i>
                <span>دعم VIP 24/7</span>
            </div>
            <div class="top-bar-item">
                <i class="fas fa-gem"></i>
                <span>منتجات أصلية 100%</span>
            </div>
            <div class="theme-toggle" onclick="toggleTheme()" id="themeToggle">
                <i class="fas fa-moon"></i>
                <span>ليلي</span>
            </div>
        </div>
    </div>

    <!-- الهيدر الرئيسي -->
    <header class="main-header">
        <div class="container header-content">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-leaf"></i>
                </div>
                <div class="logo-text">
                    <h1>نكهة وجمال</h1>
                    <span>ناردو برو - المتجر الذكي 2026</span>
                </div>
            </div>
            
            <!-- شريط البحث -->
            <div class="search-wrapper">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ابحث عن منتج..." onkeyup="searchProducts()">
                    <button onclick="searchProducts()"><i class="fas fa-search"></i></button>
                </div>
            </div>
            
            <!-- أزرار الإجراءات -->
            <div class="header-actions">
                <button class="action-btn" onclick="openLoginModal()" id="userBtn">
                    <i class="far fa-user"></i>
                </button>
                <button class="action-btn" onclick="toggleCart()">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count" id="cartCounter">0</span>
                </button>
                <button class="action-btn admin-only" onclick="openDashboard()" id="dashboardBtn" style="display: none;">
                    <i class="fas fa-chart-line"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- القائمة الرئيسية -->
    <div class="container">
        <nav class="nav-menu" id="mainNav">
            <a class="nav-link active" onclick="filterProducts('all')">
                <i class="fas fa-home"></i>
                <span>الرئيسية</span>
            </a>
            <a class="nav-link" onclick="filterProducts('promo')">
                <i class="fas fa-fire"></i>
                <span>برموسيو</span>
            </a>
            <a class="nav-link" onclick="filterProducts('spices')">
                <i class="fas fa-mortar-pestle"></i>
                <span>توابل</span>
            </a>
            <a class="nav-link" onclick="filterProducts('cosmetic')">
                <i class="fas fa-spa"></i>
                <span>كوسمتيك</span>
            </a>
            <a class="nav-link" onclick="filterProducts('other')">
                <i class="fas fa-gem"></i>
                <span>منتوجات أخرى</span>
            </a>
        </nav>
    </div>

    <!-- لوحة التاجر (تظهر للتاجر فقط) -->
    <div class="container" id="merchantPanelContainer" style="display: none;"></div>

    <!-- المنتجات - شبكة 3 أعمدة -->
    <div class="container">
        <div class="products-grid" id="productsContainer"></div>
    </div>

    <!-- لوحة التحكم (للمدير فقط) -->
    <div class="container dashboard-section admin-only" id="dashboardSection" style="display: none;">
        <div class="dashboard-tabs">
            <button class="dashboard-tab active" onclick="switchDashboardTab('overview')">نظرة عامة</button>
            <button class="dashboard-tab" onclick="switchDashboardTab('orders')">الطلبات</button>
            <button class="dashboard-tab" onclick="switchDashboardTab('analytics')">التحليلات</button>
            <button class="dashboard-tab" onclick="switchDashboardTab('products')">إدارة المنتجات</button>
            <button class="dashboard-tab" onclick="switchDashboardTab('merchants')">التجار</button>
        </div>

        <div class="dashboard-content" id="dashboardContent">
            <!-- المحتوى يتم تعبئته بواسطة JavaScript -->
        </div>
    </div>

    <!-- الفوتر -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h3>نكهة وجمال</h3>
                    <p><i class="fas fa-store"></i> المتجر الذكي المتكامل</p>
                    <p><i class="fas fa-star"></i> التقييم: <span id="footerRating">4.8</span>/5</p>
                </div>
                <div class="footer-col">
                    <h3>اتصل بنا</h3>
                    <p><i class="fab fa-whatsapp"></i> +213 562243648</p>
                    <p><i class="fas fa-phone"></i> 023 000 000</p>
                    <p><i class="fas fa-envelope"></i> info@nakha-wajamal.com</p>
                </div>
                <div class="footer-col">
                    <h3>تابعنا</h3>
                    <p><i class="fab fa-facebook"></i> فيسبوك</p>
                    <p><i class="fab fa-instagram"></i> انستغرام</p>
                    <p><i class="fab fa-tiktok"></i> تيك توك</p>
                </div>
                <div class="footer-col">
                    <h3>روابط سريعة</h3>
                    <p><i class="fas fa-question-circle"></i> عن المتجر</p>
                    <p><i class="fas fa-shield-alt"></i> سياسة الخصوصية</p>
                    <p><i class="fas fa-truck"></i> الشحن والتوصيل</p>
                </div>
            </div>
            <div class="copyright">
                © 2026 نكهة وجمال | ناردو برو - جميع الحقوق محفوظة
            </div>
        </div>
    </footer>

    <!-- النوافذ المنبثقة -->
    
    <!-- نافذة تسجيل الدخول -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <h2 style="text-align: center; margin-bottom: 30px;">
                <i class="fas fa-user-circle" style="color: var(--gold);"></i> تسجيل الدخول
            </h2>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn-gold" style="flex: 1;" onclick="switchAuthTab('login')">تسجيل دخول</button>
                <button class="btn-outline-gold" style="flex: 1;" onclick="switchAuthTab('register')">حساب جديد</button>
            </div>

            <!-- نموذج تسجيل الدخول -->
            <form id="loginForm" onsubmit="event.preventDefault(); handleLogin();">
                <div class="form-group">
                    <label>اسم المستخدم أو البريد الإلكتروني</label>
                    <input type="text" class="form-control" id="loginEmail" value="azer" placeholder="أدخل azer">
                </div>
                <div class="form-group">
                    <label>كلمة المرور</label>
                    <input type="password" class="form-control" id="loginPassword" value="123456" placeholder="أدخل 123456">
                </div>
                <button type="submit" class="btn-gold" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-sign-in-alt"></i> دخول
                </button>
            </form>

            <!-- نموذج التسجيل -->
            <form id="registerForm" style="display: none;" onsubmit="event.preventDefault(); handleRegister();">
                <div class="form-group">
                    <label>الاسم الكامل</label>
                    <input type="text" class="form-control" id="regName" required>
                </div>
                <div class="form-group">
                    <label>البريد الإلكتروني</label>
                    <input type="email" class="form-control" id="regEmail" required>
                </div>
                <div class="form-group">
                    <label>كلمة المرور</label>
                    <input type="password" class="form-control" id="regPassword" required>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="isMerchant" onchange="toggleMerchantFields()">
                        <span>تسجيل كتاجر</span>
                    </label>
                </div>
                
                <div id="merchantFields" style="display: none;">
                    <div class="form-group">
                        <label>مستوى التاجر</label>
                        <select class="form-control" id="merchantLevel">
                            <option value="1">المستوى الأول (5 منتجات)</option>
                            <option value="2">المستوى الثاني (10 منتجات)</option>
                            <option value="3">المستوى الثالث (15 منتج)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>وصف النشاط التجاري</label>
                        <textarea class="form-control" id="merchantDesc" rows="3"></textarea>
                    </div>
                </div>

                <button type="submit" class="btn-gold" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-user-plus"></i> تسجيل
                </button>
            </form>

            <button class="btn-outline-gold" style="width: 100%; margin-top: 15px;" onclick="closeModal('loginModal')">
                إلغاء
            </button>
        </div>
    </div>

    <!-- نافذة إضافة منتج -->
    <div class="modal" id="productModal">
        <div class="modal-content modal-lg">
            <h2 style="text-align: center; margin-bottom: 30px;">
                <i class="fas fa-plus-circle" style="color: var(--gold);"></i>
                <span id="modalTitle">إضافة منتج جديد</span>
            </h2>

            <form id="productForm" class="product-form">
                <div class="form-group">
                    <label>اسم المنتج</label>
                    <input type="text" class="form-control" id="productName" required>
                </div>

                <div class="form-group">
                    <label>القسم</label>
                    <select class="form-control" id="productCategory" required>
                        <option value="">اختر القسم</option>
                        <option value="promo">برموسيو</option>
                        <option value="spices">توابل</option>
                        <option value="cosmetic">كوسمتيك</option>
                        <option value="other">منتوجات أخرى</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>السعر (دج)</label>
                    <input type="number" class="form-control" id="productPrice" required min="0">
                </div>

                <div class="form-group">
                    <label>الكمية</label>
                    <input type="number" class="form-control" id="productStock" required min="0">
                </div>

                <div class="form-group" id="merchantSelectGroup">
                    <label>التاجر</label>
                    <select class="form-control" id="productMerchant">
                        <option value="">منتج عام</option>
                    </select>
                </div>

                <!-- رفع الصور -->
                <div class="form-group">
                    <label>صور المنتج</label>
                    <div class="image-upload-area" onclick="document.getElementById('productImages').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>اضغط لرفع الصور أو اسحبها هنا</p>
                    </div>
                    <input type="file" id="productImages" multiple accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                    <div class="image-preview" id="imagePreview"></div>
                </div>

                <input type="hidden" id="editingProductId">
                <input type="hidden" id="productImagesData">

                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button type="button" class="btn-gold" style="flex: 2;" onclick="saveProduct()">
                        <i class="fas fa-save"></i> حفظ المنتج
                    </button>
                    <button type="button" class="btn-outline-gold" style="flex: 1;" onclick="closeModal('productModal')">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- نافذة تفاصيل المنتج -->
    <div class="modal" id="productDetailModal">
        <div class="modal-content modal-lg" id="productDetailContent">
            <!-- يتم تعبئتها ديناميكياً -->
        </div>
    </div>

    <script>
        // ========== 1. النظام الأساسي ==========
        // المتغيرات العامة
        let products = [];
        let currentUser = null;
        let cart = [];
        let isDarkMode = true;
        let currentFilter = 'all';
        let searchTerm = '';

        // ========== 2. نظام إدارة الطلبات (مع واتساب) ==========
        class OrderManagementSystem {
            constructor() {
                this.orders = this.loadOrders();
                this.orderStatuses = ['pending', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled'];
            }

            loadOrders() {
                const saved = localStorage.getItem('nardoo_orders_management');
                return saved ? JSON.parse(saved) : [];
            }

            saveOrders() {
                localStorage.setItem('nardoo_orders_management', JSON.stringify(this.orders));
            }

            generateOrderId() {
                return `ORD${Date.now()}${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
            }

            createOrder(orderData) {
                const order = {
                    id: this.generateOrderId(),
                    customerId: orderData.customerId || null,
                    customerName: orderData.customerName,
                    customerPhone: orderData.customerPhone,
                    customerAddress: orderData.customerAddress,
                    items: orderData.items || [],
                    subtotal: 0,
                    tax: 0,
                    shipping: orderData.shipping || 0,
                    discount: orderData.discount || 0,
                    total: 0,
                    paymentMethod: orderData.paymentMethod || 'الواتساب',
                    notes: orderData.notes || '',
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    timeline: [{
                        status: 'pending',
                        timestamp: new Date().toISOString(),
                        message: 'تم إنشاء الطلب'
                    }]
                };

                order.subtotal = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                order.tax = Math.round(order.subtotal * 0.09);
                order.total = order.subtotal + order.tax + order.shipping - order.discount;

                this.orders.push(order);
                this.saveOrders();
                return order;
            }

            getOrder(orderId) {
                return this.orders.find(o => o.id === orderId);
            }

            getCustomerOrders(customerId) {
                return this.orders.filter(o => o.customerId === customerId);
            }

            updateOrderStatus(orderId, newStatus, message = '') {
                const order = this.getOrder(orderId);
                if (!order) return false;

                order.status = newStatus;
                order.updatedAt = new Date().toISOString();
                order.timeline.push({
                    status: newStatus,
                    timestamp: new Date().toISOString(),
                    message: message || this.getStatusMessage(newStatus)
                });

                this.saveOrders();
                return true;
            }

            getStatusMessage(status) {
                const messages = {
                    'pending': 'في انتظار التأكيد',
                    'confirmed': 'تم تأكيد الطلب',
                    'processing': 'جاري المعالجة',
                    'shipped': 'تم الشحن',
                    'delivered': 'تم التسليم',
                    'cancelled': 'تم الإلغاء'
                };
                return messages[status] || 'تحديث الطلب';
            }

            getOrderStatistics() {
                const stats = {
                    totalOrders: this.orders.length,
                    totalRevenue: 0,
                    averageOrderValue: 0,
                    ordersByStatus: {},
                    recentOrders: []
                };

                this.orderStatuses.forEach(s => stats.ordersByStatus[s] = 0);

                this.orders.forEach(order => {
                    stats.totalRevenue += order.total;
                    stats.ordersByStatus[order.status]++;
                });

                stats.averageOrderValue = stats.totalOrders > 0 ? stats.totalRevenue / stats.totalOrders : 0;
                stats.recentOrders = this.orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 10);

                return stats;
            }

            searchOrders(filters = {}) {
                return this.orders.filter(order => {
                    if (filters.status && order.status !== filters.status) return false;
                    if (filters.customerId && order.customerId !== filters.customerId) return false;
                    if (filters.search) {
                        const term = filters.search.toLowerCase();
                        return order.id.toLowerCase().includes(term) ||
                               order.customerName.toLowerCase().includes(term) ||
                               order.customerPhone.includes(term);
                    }
                    return true;
                });
            }
        }

        // ========== 3. نظام الواتساب (معدل) ==========
        class WhatsAppIntegration {
            constructor() {
                this.storePhone = '213562243648';
                this.orderHistory = this.loadOrderHistory();
            }

            loadOrderHistory() {
                const saved = localStorage.getItem('nardoo_order_history');
                return saved ? JSON.parse(saved) : [];
            }

            saveOrderHistory() {
                localStorage.setItem('nardoo_order_history', JSON.stringify(this.orderHistory));
            }

            formatOrderMessage(orderData) {
                const {
                    items = [],
                    customerName = currentUser?.name || 'عميل',
                    customerPhone = '',
                    customerAddress = '',
                    paymentMethod = 'الواتساب',
                    notes = '',
                    orderId = ''
                } = orderData;

                let message = '🛍️ *طلب جديد من نكهة وجمال*\n';
                message += '━━━━━━━━━━━━━━━━━━━━━━\n\n';

                message += '👤 *العميل:*\n';
                message += `  • الاسم: ${customerName}\n`;
                message += `  • الهاتف: ${customerPhone || 'غير متوفر'}\n`;
                message += `  • العنوان: ${customerAddress || 'غير محدد'}\n\n`;

                message += '📦 *المنتجات:*\n';
                items.forEach((item, i) => {
                    message += `  ${i+1}. ${item.name}\n`;
                    message += `     • ${item.price.toLocaleString()} دج × ${item.quantity}\n`;
                });

                const subtotal = items.reduce((s, i) => s + (i.price * i.quantity), 0);
                const shipping = this.calculateShipping(customerAddress);
                const total = subtotal + shipping;

                message += '\n💰 *المجموع:*\n';
                message += `  • المجموع الفرعي: ${subtotal.toLocaleString()} دج\n`;
                message += `  • الشحن: ${shipping} دج\n`;
                message += `  • *الإجمالي: ${total.toLocaleString()} دج*\n\n`;

                message += `💳 *الدفع:* ${paymentMethod}\n`;
                if (notes) message += `📝 *ملاحظات:* ${notes}\n`;
                if (orderId) message += `🔔 *معرّف الطلب:* #${orderId}\n`;

                return message;
            }

            calculateShipping(address) {
                if (!address) return 800;
                const rates = {
                    'الجزائر': 500,
                    'وهران': 700,
                    'قسنطينة': 800,
                    'الجنوب': 1200
                };

                for (const [region, cost] of Object.entries(rates)) {
                    if (address.includes(region)) return cost;
                }
                return 800;
            }

            sendOrder(orderData, recipientPhone = null) {
                const message = this.formatOrderMessage(orderData);
                const phone = recipientPhone || this.storePhone;
                window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');

                const order = {
                    id: `WH${Date.now()}`,
                    ...orderData,
                    timestamp: new Date().toISOString(),
                    status: 'sent'
                };
                this.orderHistory.push(order);
                this.saveOrderHistory();

                return order.id;
            }

            getOrderHistory() {
                return this.orderHistory;
            }

            getSalesStatistics() {
                const stats = {
                    totalOrders: this.orderHistory.length,
                    totalRevenue: 0,
                    averageOrderValue: 0
                };

                this.orderHistory.forEach(order => {
                    const total = order.items.reduce((s, i) => s + (i.price * i.quantity), 0);
                    stats.totalRevenue += total;
                });

                stats.averageOrderValue = stats.totalOrders > 0 ? stats.totalRevenue / stats.totalOrders : 0;
                return stats;
            }
        }

        // ========== 4. نظام التحليلات (للمدير فقط) ==========
        class AnalyticsSystem {
            constructor() {
                this.events = this.loadEvents();
                this.pageViews = this.loadPageViews();
                this.userSessions = this.loadUserSessions();
            }

            loadEvents() {
                const saved = localStorage.getItem('nardoo_analytics_events');
                return saved ? JSON.parse(saved) : [];
            }

            loadPageViews() {
                const saved = localStorage.getItem('nardoo_page_views');
                return saved ? JSON.parse(saved) : [];
            }

            loadUserSessions() {
                const saved = localStorage.getItem('nardoo_user_sessions');
                return saved ? JSON.parse(saved) : [];
            }

            saveEvents() {
                localStorage.setItem('nardoo_analytics_events', JSON.stringify(this.events));
            }

            savePageViews() {
                localStorage.setItem('nardoo_page_views', JSON.stringify(this.pageViews));
            }

            saveUserSessions() {
                localStorage.setItem('nardoo_user_sessions', JSON.stringify(this.userSessions));
            }

            trackEvent(eventType, eventData = {}) {
                const event = {
                    id: `EVT${Date.now()}${Math.random().toString(36).substring(2, 8)}`,
                    type: eventType,
                    data: eventData,
                    timestamp: new Date().toISOString(),
                    url: window.location.href
                };
                this.events.push(event);
                this.saveEvents();
            }

            trackPageView(pageName) {
                this.pageViews.push({
                    id: `PV${Date.now()}`,
                    pageName,
                    timestamp: new Date().toISOString(),
                    referrer: document.referrer
                });
                this.savePageViews();
            }

            getVisitStatistics() {
                return {
                    totalPageViews: this.pageViews.length,
                    uniquePages: new Set(this.pageViews.map(p => p.pageName)).size,
                    totalEvents: this.events.length
                };
            }

            getConversionRate() {
                const cartEvents = this.events.filter(e => e.type === 'addToCart').length;
                const purchaseEvents = this.events.filter(e => e.type === 'purchase').length;
                return cartEvents > 0 ? ((purchaseEvents / cartEvents) * 100).toFixed(2) : 0;
            }

            generateComprehensiveReport() {
                return {
                    visits: this.getVisitStatistics(),
                    conversionRate: this.getConversionRate(),
                    eventsByType: this.events.reduce((acc, e) => {
                        acc[e.type] = (acc[e.type] || 0) + 1;
                        return acc;
                    }, {})
                };
            }
        }

        // ========== إنشاء الكائنات ==========
        const orderManager = new OrderManagementSystem();
        const whatsappManager = new WhatsAppIntegration();
        const analyticsManager = new AnalyticsSystem();

        // ========== إعداد حساب المدير ==========
        function setupAdminAccount() {
            try {
                let users = JSON.parse(localStorage.getItem('nardoo_users') || '[]');
                const adminExists = users.some(u => u.name === 'azer' || u.email === 'azer@admin.com');
                
                if (!adminExists) {
                    const adminUser = {
                        id: users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1,
                        name: 'azer',
                        email: 'azer@admin.com',
                        password: '123456',
                        role: 'admin',
                        createdAt: new Date().toISOString()
                    };
                    
                    users.push(adminUser);
                    localStorage.setItem('nardoo_users', JSON.stringify(users));
                    console.log('✅ تم إنشاء حساب المدير: azer / 123456');
                }
            } catch(e) {
                console.log('خطأ في إعداد المدير:', e);
            }
        }

        setupAdminAccount();

        // ========== دوال المساعدة ==========
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            container.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('light-mode', !isDarkMode);
            const toggle = document.getElementById('themeToggle');
            toggle.innerHTML = isDarkMode ? 
                '<i class="fas fa-moon"></i><span>ليلي</span>' : 
                '<i class="fas fa-sun"></i><span>نهاري</span>';
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        }

        // ========== إدارة المنتجات ==========
        function loadProducts() {
            const saved = localStorage.getItem('nardoo_products');
            if (saved) {
                products = JSON.parse(saved);
            } else {
                // منتجات افتراضية
                products = [
                    { 
                        id: 1, 
                        name: "عرض رمضان - طقم بهارات كامل", 
                        category: "promo", 
                        price: 3500, 
                        stock: 20, 
                        rating: 5.0,
                        images: [
                            "https://via.placeholder.com/300/ff6b6b/ffffff?text=عرض+رمضان",
                            "https://via.placeholder.com/300/ff8787/ffffff?text=Ramadan+Offer"
                        ],
                        merchantId: null
                    },
                    { 
                        id: 2, 
                        name: "بهارات برياني أصلية - خلطة خاصة", 
                        category: "spices", 
                        price: 4500, 
                        stock: 15, 
                        rating: 4.5,
                        images: [
                            "https://via.placeholder.com/300/ffd93d/000000?text=برياني",
                            "https://via.placeholder.com/300/ffd700/000000?text=برياني+2"
                        ],
                        merchantId: null
                    },
                    { 
                        id: 3, 
                        name: "زعفران أصلي - درجة أولى", 
                        category: "spices", 
                        price: 12000, 
                        stock: 25, 
                        rating: 5.0,
                        images: [
                            "https://via.placeholder.com/300/8b0000/ffffff?text=زعفران",
                            "https://via.placeholder.com/300/a52a2a/ffffff?text=Saffron"
                        ],
                        merchantId: null
                    },
                    { 
                        id: 4, 
                        name: "زيت أرغان للشعر - عضوي 100%", 
                        category: "cosmetic", 
                        price: 3500, 
                        stock: 8, 
                        rating: 4.8,
                        images: [
                            "https://via.placeholder.com/300/ff9f9f/000000?text=أرغان",
                            "https://via.placeholder.com/300/ffb6c1/000000?text=Argan"
                        ],
                        merchantId: null
                    },
                    { 
                        id: 5, 
                        name: "ماسك طين طبيعي - للبشرة", 
                        category: "cosmetic", 
                        price: 2500, 
                        stock: 3, 
                        rating: 4.3,
                        images: [
                            "https://via.placeholder.com/300/228b22/ffffff?text=طين"
                        ],
                        merchantId: null
                    },
                    { 
                        id: 6, 
                        name: "كريم ترطيب للوجه - بزبدة الشيا", 
                        category: "cosmetic", 
                        price: 2800, 
                        stock: 12, 
                        rating: 4.4,
                        images: [
                            "https://via.placeholder.com/300/8fbc8f/ffffff?text=كريم"
                        ],
                        merchantId: null
                    },
                    { 
                        id: 7, 
                        name: "سماعات بلوتوث لاسلكية", 
                        category: "other", 
                        price: 6500, 
                        stock: 9, 
                        rating: 4.6,
                        images: [
                            "https://via.placeholder.com/300/4682b4/ffffff?text=سماعات"
                        ],
                        merchantId: null
                    },
                    { 
                        id: 8, 
                        name: "هاتف ذكي - شاشة 6.5 بوصة", 
                        category: "other", 
                        price: 45000, 
                        stock: 5, 
                        rating: 4.7,
                        images: [
                            "https://via.placeholder.com/300/000000/ffffff?text=هاتف"
                        ],
                        merchantId: null
                    },
                    { 
                        id: 9, 
                        name: "قميص رجالي قطني", 
                        category: "other", 
                        price: 3200, 
                        stock: 4, 
                        rating: 4.2,
                        images: [
                            "https://via.placeholder.com/300/556b2f/ffffff?text=قميص"
                        ],
                        merchantId: null
                    }
                ];
            }
            saveProducts();
            displayProducts();
        }

        function saveProducts() {
            localStorage.setItem('nardoo_products', JSON.stringify(products));
        }

        function displayProducts() {
            const container = document.getElementById('productsContainer');
            if (!container) return;

            let filtered = products.filter(p => p.stock > 0);
            
            // إذا كان التاجر يشاهد منتجاته فقط
            if (currentFilter === 'my_products' && currentUser?.role === 'merchant_approved') {
                filtered = filtered.filter(p => p.merchantId === currentUser.id);
            }
            // التصفية حسب التصنيف العادي
            else if (currentFilter !== 'all') {
                filtered = filtered.filter(p => p.category === currentFilter);
            }

            if (searchTerm) {
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 50px;">
                        <i class="fas fa-box-open" style="font-size: 60px; color: var(--gold); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--gold);">لا توجد منتجات</h3>
                        <p>لا توجد منتجات في هذا القسم</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(product => {
                const stockClass = product.stock <= 0 ? 'out-of-stock' : product.stock < 5 ? 'low-stock' : 'in-stock';
                const stockText = product.stock <= 0 ? 'غير متوفر' : product.stock < 5 ? `كمية محدودة (${product.stock})` : `متوفر (${product.stock})`;

                const images = product.images && product.images.length > 0 ? product.images : [
                    "https://via.placeholder.com/300/2c5e4f/ffffff?text=نكهة+وجمال"
                ];

                const slides = images.map((img, idx) => `
                    <div class="swiper-slide">
                        <img src="${img}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/300/2c5e4f/ffffff?text=صورة+غير+متوفرة'; this.onerror=null;">
                    </div>
                `).join('');

                let categoryIcon = 'fas fa-tag';
                if (product.category === 'promo') categoryIcon = 'fas fa-fire';
                else if (product.category === 'spices') categoryIcon = 'fas fa-mortar-pestle';
                else if (product.category === 'cosmetic') categoryIcon = 'fas fa-spa';
                else if (product.category === 'other') categoryIcon = 'fas fa-gem';

                const merchant = users.find(u => u.id === product.merchantId);

                return `
                    <div class="product-card" data-id="${product.id}">
                        <div class="product-badge">${product.rating} ⭐</div>
                        ${product.merchantId ? `<div class="merchant-badge"><i class="fas fa-store"></i> ${merchant?.name || 'تاجر'}</div>` : ''}
                        
                        <div class="product-gallery">
                            <div class="swiper product-swiper-${product.id}">
                                <div class="swiper-wrapper">
                                    ${slides}
                                </div>
                                <div class="swiper-pagination"></div>
                                <div class="swiper-button-next"></div>
                                <div class="swiper-button-prev"></div>
                            </div>
                        </div>

                        <div class="product-info">
                            <div class="product-category">
                                <i class="${categoryIcon}"></i> ${getCategoryName(product.category)}
                            </div>
                            <h3 class="product-title">${product.name}</h3>
                            <div class="product-price">${product.price.toLocaleString()} <small>دج</small></div>
                            <div class="product-stock ${stockClass}">${stockText}</div>
                            
                            <div class="product-actions">
                                <button class="add-to-cart" onclick="addToCart(${product.id})" ${product.stock <= 0 ? 'disabled' : ''}>
                                    <i class="fas fa-shopping-cart"></i> أضف للسلة
                                </button>
                                <button class="wishlist-btn" onclick="viewProductDetails(${product.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            setTimeout(() => {
                filtered.forEach(product => {
                    if (document.querySelector(`.product-swiper-${product.id}`)) {
                        new Swiper(`.product-swiper-${product.id}`, {
                            pagination: { el: '.swiper-pagination', clickable: true },
                            navigation: {
                                nextEl: '.swiper-button-next',
                                prevEl: '.swiper-button-prev',
                            },
                            loop: images.length > 1,
                            autoplay: images.length > 1 ? {
                                delay: 3000,
                                disableOnInteraction: false,
                            } : false,
                        });
                    }
                });
            }, 200);

            analyticsManager.trackPageView('products');
        }

        function getCategoryName(category) {
            const names = {
                'promo': 'برموسيو',
                'spices': 'توابل',
                'cosmetic': 'كوسمتيك',
                'other': 'منتوجات أخرى'
            };
            return names[category] || 'أخرى';
        }

        function filterProducts(category) {
            currentFilter = category;
            
            document.querySelectorAll('.nav-link, .category-btn').forEach(el => {
                el.classList.remove('active');
            });
            
            document.querySelectorAll(`[onclick*="'${category}'"]`).forEach(el => {
                el.classList.add('active');
            });
            
            displayProducts();
        }

        function searchProducts() {
            searchTerm = document.getElementById('searchInput').value;
            displayProducts();
            analyticsManager.trackEvent('search', { searchTerm });
        }

        // ========== إدارة السلة ==========
        function loadCart() {
            const saved = localStorage.getItem('nardoo_cart');
            cart = saved ? JSON.parse(saved) : [];
            updateCartCounter();
        }

        function saveCart() {
            localStorage.setItem('nardoo_cart', JSON.stringify(cart));
        }

        function updateCartCounter() {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCounter').textContent = count;
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || product.stock <= 0) {
                showNotification('المنتج غير متوفر', 'error');
                return;
            }

            const existing = cart.find(item => item.productId === productId);
            if (existing) {
                if (existing.quantity < product.stock) {
                    existing.quantity++;
                } else {
                    showNotification('الكمية المتوفرة غير كافية', 'warning');
                    return;
                }
            } else {
                cart.push({
                    productId,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    image: product.images?.[0] || ''
                });
            }

            saveCart();
            updateCartCounter();
            updateCartDisplay();
            showNotification('تمت الإضافة إلى السلة', 'success');
            analyticsManager.trackEvent('addToCart', { productId });
        }

        function toggleCart() {
            document.getElementById('cartSidebar').classList.toggle('open');
            updateCartDisplay();
        }

        function updateCartDisplay() {
            const itemsDiv = document.getElementById('cartItems');
            const totalSpan = document.getElementById('cartTotal');

            if (cart.length === 0) {
                itemsDiv.innerHTML = '<div style="text-align: center; padding: 40px;">السلة فارغة</div>';
                totalSpan.textContent = '0 دج';
                return;
            }

            let total = 0;
            itemsDiv.innerHTML = cart.map(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                return `
                    <div class="cart-item">
                        <div class="cart-item-image">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="cart-item-details">
                            <div class="cart-item-title">${item.name}</div>
                            <div class="cart-item-price">${item.price.toLocaleString()} دج</div>
                            <div class="cart-item-quantity">
                                <button class="quantity-btn" onclick="updateCartItem(${item.productId}, ${item.quantity - 1})">-</button>
                                <span>${item.quantity}</span>
                                <button class="quantity-btn" onclick="updateCartItem(${item.productId}, ${item.quantity + 1})">+</button>
                                <button class="quantity-btn" onclick="removeFromCart(${item.productId})" style="background: #f87171; color: white;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            totalSpan.textContent = `${total.toLocaleString()} دج`;
        }

        function updateCartItem(productId, newQuantity) {
            const item = cart.find(i => i.productId === productId);
            const product = products.find(p => p.id === productId);

            if (newQuantity <= 0) {
                removeFromCart(productId);
                return;
            }

            if (newQuantity > product.stock) {
                showNotification('الكمية غير متوفرة', 'warning');
                return;
            }

            item.quantity = newQuantity;
            saveCart();
            updateCartCounter();
            updateCartDisplay();
        }

        function removeFromCart(productId) {
            cart = cart.filter(i => i.productId !== productId);
            saveCart();
            updateCartCounter();
            updateCartDisplay();
            showNotification('تمت إزالة المنتج من السلة', 'info');
        }

        function checkoutCart() {
            if (cart.length === 0) {
                showNotification('السلة فارغة', 'warning');
                return;
            }

            const orderData = {
                items: cart,
                customerName: currentUser?.name || 'عميل',
                customerPhone: '',
                customerAddress: '',
                paymentMethod: 'الواتساب'
            };

            const order = orderManager.createOrder({
                ...orderData,
                customerId: currentUser?.id
            });

            whatsappManager.sendOrder({
                ...orderData,
                orderId: order.id
            });

            cart = [];
            saveCart();
            updateCartCounter();
            toggleCart();

            showNotification('تم إرسال الطلب عبر واتساب بنجاح', 'success');
            analyticsManager.trackEvent('checkout', { orderId: order.id });
        }

        // ========== عرض تفاصيل المنتج ==========
        function viewProductDetails(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const modal = document.getElementById('productDetailModal');
            const content = document.getElementById('productDetailContent');

            const images = product.images?.map(img => `
                <img src="${img}" style="width: 100%; height: 300px; object-fit: cover; border-radius: 20px; margin-bottom: 10px;">
            `).join('') || '<div style="height: 300px; background: var(--nardoo); display: flex; align-items: center; justify-content: center; border-radius: 20px;"><i class="fas fa-image" style="font-size: 80px; color: var(--gold);"></i></div>';

            content.innerHTML = `
                <h2 style="text-align: center; margin-bottom: 20px; color: var(--gold);">${product.name}</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <div style="display: grid; gap: 10px;">
                            ${images}
                        </div>
                    </div>
                    <div>
                        <div style="margin-bottom: 20px;">
                            <span style="background: var(--gold); padding: 5px 15px; border-radius: 20px; color: var(--bg-primary); font-weight: 700;">${getCategoryName(product.category)}</span>
                        </div>
                        <p style="margin-bottom: 20px; color: var(--text-secondary);">${product.description || 'منتج عالي الجودة من نكهة وجمال'}</p>
                        <div style="margin-bottom: 20px;">
                            <span style="font-size: 32px; font-weight: 800; color: var(--gold);">${product.price.toLocaleString()}</span>
                            <small style="color: var(--gold-light);"> دج</small>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <span class="product-stock ${product.stock <= 0 ? 'out-of-stock' : product.stock < 5 ? 'low-stock' : 'in-stock'}" style="padding: 8px 15px;">
                                ${product.stock <= 0 ? 'غير متوفر' : product.stock < 5 ? `كمية محدودة (${product.stock})` : `متوفر (${product.stock})`}
                            </span>
                        </div>
                        <div style="display: flex; gap: 15px;">
                            <button class="btn-gold" style="flex: 2;" onclick="addToCart(${product.id}); closeModal('productDetailModal')">
                                <i class="fas fa-shopping-cart"></i> أضف للسلة
                            </button>
                            <button class="btn-outline-gold" style="flex: 1;" onclick="closeModal('productDetailModal')">
                                إغلاق
                            </button>
                        </div>
                    </div>
                </div>
            `;

            modal.style.display = 'flex';
        }

        // ========== إدارة المستخدمين والصلاحيات ==========
        function loadUsers() {
            const saved = localStorage.getItem('nardoo_users');
            if (saved) {
                return JSON.parse(saved);
            }
            return [
                { id: 1, name: 'azer', email: 'azer@admin.com', password: '123456', role: 'admin' }
            ];
        }

        let users = loadUsers();

        function saveUsers() {
            localStorage.setItem('nardoo_users', JSON.stringify(users));
        }

        function openLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
        }

        function switchAuthTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const buttons = document.querySelectorAll('#loginModal .btn-gold, #loginModal .btn-outline-gold');

            if (tab === 'login') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                buttons[0].className = 'btn-gold';
                buttons[1].className = 'btn-outline-gold';
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                buttons[0].className = 'btn-outline-gold';
                buttons[1].className = 'btn-gold';
            }
        }

        function toggleMerchantFields() {
            const isMerchant = document.getElementById('isMerchant').checked;
            document.getElementById('merchantFields').style.display = isMerchant ? 'block' : 'none';
        }

        function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const user = users.find(u => (u.email === email || u.name === email) && u.password === password);

            if (user) {
                currentUser = user;
                localStorage.setItem('current_user', JSON.stringify(user));
                closeModal('loginModal');
                
                // تحديث الواجهة حسب الدور
                updateUIBasedOnRole();
                
                showNotification(`مرحباً ${user.name}`, 'success');
                analyticsManager.trackEvent('login', { userId: user.id, role: user.role });
            } else {
                showNotification('بيانات الدخول غير صحيحة', 'error');
            }
        }

        function updateUIBasedOnRole() {
            if (!currentUser) return;

            // إخفاء كل العناصر أولاً
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = 'none';
            });
            
            // إخفاء لوحة التاجر
            document.getElementById('merchantPanelContainer').style.display = 'none';
            
            // إزالة زر "منتجاتي" إذا كان موجوداً
            const myProductsBtn = document.getElementById('myProductsBtn');
            if (myProductsBtn) myProductsBtn.remove();

            if (currentUser.role === 'admin') {
                // المدير: يظهر زر لوحة التحكم
                document.getElementById('dashboardBtn').style.display = 'flex';
                document.getElementById('userBtn').innerHTML = '<i class="fas fa-crown"></i>';
                
                // إظهار العناصر الخاصة بالمدير
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = 'block';
                });
                
                showNotification('مرحباً بك يا مدير - لديك صلاحيات كاملة', 'success');
            } 
            else if (currentUser.role === 'merchant_approved') {
                // التاجر: لا يرى لوحة التحكم، يرى لوحة التاجر
                document.getElementById('dashboardBtn').style.display = 'none';
                document.getElementById('userBtn').innerHTML = '<i class="fas fa-store"></i>';
                
                // إضافة زر "منتجاتي" في القائمة
                addMerchantMenuButton();
                
                // عرض لوحة التاجر
                showMerchantPanel();
                
                showNotification('مرحباً أيها التاجر - يمكنك إدارة منتجاتك فقط', 'info');
            } 
            else {
                // عميل عادي
                document.getElementById('dashboardBtn').style.display = 'none';
                document.getElementById('userBtn').innerHTML = '<i class="fas fa-user"></i>';
            }
        }

        // إضافة زر للتاجر لعرض منتجاته
        function addMerchantMenuButton() {
            const navMenu = document.getElementById('mainNav');
            if (navMenu && !document.getElementById('myProductsBtn')) {
                const btn = document.createElement('a');
                btn.className = 'nav-link';
                btn.id = 'myProductsBtn';
                btn.setAttribute('onclick', 'viewMyProducts()');
                btn.innerHTML = '<i class="fas fa-box"></i><span>منتجاتي</span>';
                navMenu.appendChild(btn);
            }
        }

        // عرض منتجات التاجر فقط
        function viewMyProducts() {
            if (!currentUser || currentUser.role !== 'merchant_approved') return;
            currentFilter = 'my_products';
            
            document.querySelectorAll('.nav-link, .category-btn').forEach(el => {
                el.classList.remove('active');
            });
            
            document.getElementById('myProductsBtn').classList.add('active');
            displayProducts();
        }

        // عرض لوحة التاجر
        function showMerchantPanel() {
            if (!currentUser || currentUser.role !== 'merchant_approved') return;
            
            const merchantProducts = products.filter(p => p.merchantId === currentUser.id);
            const totalSales = merchantProducts.reduce((sum, p) => sum + (p.price * (p.soldCount || 0)), 0);
            
            const panelContainer = document.getElementById('merchantPanelContainer');
            panelContainer.style.display = 'block';
            
            panelContainer.innerHTML = `
                <div class="merchant-panel">
                    <h3>
                        <i class="fas fa-store"></i>
                        لوحة التاجر - ${currentUser.name}
                    </h3>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="number">${merchantProducts.length}</div>
                            <div>إجمالي المنتجات</div>
                        </div>
                        <div class="stat-item">
                            <div class="number">${merchantProducts.filter(p => p.stock > 0).length}</div>
                            <div>المنتجات المتاحة</div>
                        </div>
                        <div class="stat-item">
                            <div class="number">${totalSales.toLocaleString()} دج</div>
                            <div>إجمالي المبيعات</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; margin-top: 20px; justify-content: center;">
                        <button class="btn-gold" onclick="showAddProductModal()">
                            <i class="fas fa-plus"></i> إضافة منتج جديد
                        </button>
                        <button class="btn-outline-gold" onclick="viewMyProducts()">
                            <i class="fas fa-box"></i> عرض منتجاتي
                        </button>
                    </div>
                </div>
            `;
        }

        function handleRegister() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const isMerchant = document.getElementById('isMerchant').checked;

            if (!name || !email || !password) {
                showNotification('الرجاء ملء جميع الحقول', 'error');
                return;
            }

            if (users.find(u => u.email === email)) {
                showNotification('البريد الإلكتروني مستخدم بالفعل', 'error');
                return;
            }

            const newUser = {
                id: users.length + 1,
                name,
                email,
                password,
                role: isMerchant ? 'merchant_pending' : 'customer',
                createdAt: new Date().toISOString()
            };

            if (isMerchant) {
                newUser.merchantLevel = document.getElementById('merchantLevel').value;
                newUser.merchantDesc = document.getElementById('merchantDesc').value;
            }

            users.push(newUser);
            saveUsers();
            showNotification('تم التسجيل بنجاح' + (isMerchant ? '، طلبك قيد المراجعة' : ''), 'success');
            switchAuthTab('login');
        }

        // ========== لوحة التحكم (للمدير فقط) ==========
        function openDashboard() {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('غير مصرح لك بالدخول - هذه الصفحة للمدير فقط', 'error');
                return;
            }

            document.getElementById('dashboardSection').style.display = 'block';
            document.getElementById('dashboardSection').scrollIntoView({ behavior: 'smooth' });
            switchDashboardTab('overview');
        }

        function switchDashboardTab(tab) {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            const tabs = document.querySelectorAll('.dashboard-tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            const content = document.getElementById('dashboardContent');
            
            switch(tab) {
                case 'overview':
                    showDashboardOverview(content);
                    break;
                case 'orders':
                    showDashboardOrders(content);
                    break;
                case 'analytics':
                    showDashboardAnalytics(content);
                    break;
                case 'products':
                    showDashboardProducts(content);
                    break;
                case 'merchants':
                    showDashboardMerchants(content);
                    break;
            }
        }

        function showDashboardOverview(container) {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            const orderStats = orderManager.getOrderStatistics();
            const whatsappStats = whatsappManager.getSalesStatistics();
            const analytics = analyticsManager.generateComprehensiveReport();

            container.innerHTML = `
                <h3 style="margin-bottom: 30px; color: var(--gold);">نظرة عامة على المتجر</h3>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-shopping-cart"></i>
                        <div class="stat-value">${orderStats.totalOrders}</div>
                        <div class="stat-label">إجمالي الطلبات</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-coins"></i>
                        <div class="stat-value">${orderStats.totalRevenue.toLocaleString()}</div>
                        <div class="stat-label">الإيرادات (دج)</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-chart-line"></i>
                        <div class="stat-value">${orderStats.averageOrderValue.toFixed(0)}</div>
                        <div class="stat-label">متوسط قيمة الطلب</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-percent"></i>
                        <div class="stat-value">${analytics.conversionRate}%</div>
                        <div class="stat-label">معدل التحويل</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="ordersChart"></canvas>
                </div>

                <h4 style="margin: 30px 0 20px; color: var(--gold);">الطلبات الأخيرة</h4>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الطلب</th>
                                <th>العميل</th>
                                <th>المجموع</th>
                                <th>الحالة</th>
                                <th>التاريخ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${orderStats.recentOrders.map(order => `
                                <tr>
                                    <td>${order.id}</td>
                                    <td>${order.customerName}</td>
                                    <td style="color: var(--gold); font-weight: 700;">${order.total.toLocaleString()} دج</td>
                                    <td>
                                        <span style="background: ${order.status === 'delivered' ? '#4ade80' : order.status === 'cancelled' ? '#f87171' : '#fbbf24'}; 
                                                     color: ${order.status === 'delivered' ? '#000' : '#fff'}; 
                                                     padding: 5px 10px; border-radius: 20px; font-size: 12px;">
                                            ${orderManager.getStatusMessage(order.status)}
                                        </span>
                                    </td>
                                    <td>${new Date(order.createdAt).toLocaleDateString('ar-DZ')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            setTimeout(() => {
                const ctx = document.getElementById('ordersChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
                        datasets: [{
                            label: 'الطلبات',
                            data: [12, 19, 15, 25, 22, 30],
                            borderColor: '#d4af37',
                            backgroundColor: 'rgba(212, 175, 55, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: getComputedStyle(document.body).getPropertyValue('--text-primary') }
                            }
                        },
                        scales: {
                            y: {
                                grid: { color: 'rgba(212, 175, 55, 0.1)' },
                                ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-secondary') }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-secondary') }
                            }
                        }
                    }
                });
            }, 100);
        }

        function showDashboardOrders(container) {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            const orders = orderManager.orders;

            container.innerHTML = `
                <h3 style="margin-bottom: 30px; color: var(--gold);">إدارة الطلبات</h3>
                
                <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <input type="text" class="form-control" id="orderSearch" placeholder="بحث برقم الطلب أو اسم العميل..." style="width: 300px;">
                    <button class="btn-gold" onclick="searchOrders()">بحث</button>
                </div>

                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الطلب</th>
                                <th>العميل</th>
                                <th>المجموع</th>
                                <th>الحالة</th>
                                <th>طريقة الدفع</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${orders.map(order => `
                                <tr>
                                    <td>${order.id}</td>
                                    <td>${order.customerName}</td>
                                    <td style="color: var(--gold); font-weight: 700;">${order.total.toLocaleString()} دج</td>
                                    <td>
                                        <select class="form-control" onchange="updateOrderStatus('${order.id}', this.value)" style="width: 140px;">
                                            ${orderManager.orderStatuses.map(status => `
                                                <option value="${status}" ${order.status === status ? 'selected' : ''}>
                                                    ${orderManager.getStatusMessage(status)}
                                                </option>
                                            `).join('')}
                                        </select>
                                    </td>
                                    <td>${order.paymentMethod}</td>
                                    <td>
                                        <button class="btn-outline-gold" onclick="viewOrderDetails('${order.id}')" style="padding: 5px 10px;">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function updateOrderStatus(orderId, status) {
            if (!currentUser || currentUser.role !== 'admin') return;
            orderManager.updateOrderStatus(orderId, status);
            showNotification('تم تحديث حالة الطلب', 'success');
        }

        function showDashboardAnalytics(container) {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            const analytics = analyticsManager.generateComprehensiveReport();
            const eventsByType = Object.entries(analytics.eventsByType).map(([type, count]) => ({ type, count }));

            container.innerHTML = `
                <h3 style="margin-bottom: 30px; color: var(--gold);">التحليلات والإحصائيات</h3>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-eye"></i>
                        <div class="stat-value">${analytics.visits.totalPageViews}</div>
                        <div class="stat-label">مشاهدات الصفحات</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-chart-bar"></i>
                        <div class="stat-value">${analytics.visits.uniquePages}</div>
                        <div class="stat-label">صفحات فريدة</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-bolt"></i>
                        <div class="stat-value">${analytics.visits.totalEvents}</div>
                        <div class="stat-label">إجمالي الأحداث</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-percent"></i>
                        <div class="stat-value">${analytics.conversionRate}%</div>
                        <div class="stat-label">معدل التحويل</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="eventsChart"></canvas>
                </div>
            `;

            setTimeout(() => {
                const ctx = document.getElementById('eventsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: eventsByType.map(e => e.type),
                        datasets: [{
                            label: 'عدد الأحداث',
                            data: eventsByType.map(e => e.count),
                            backgroundColor: '#d4af37',
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(212, 175, 55, 0.1)' },
                                ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-secondary') }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-secondary') }
                            }
                        }
                    }
                });
            }, 100);
        }

        function showDashboardProducts(container) {
            if (!currentUser || currentUser.role !== 'admin') return;

            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h3 style="color: var(--gold);">إدارة المنتجات</h3>
                    <button class="btn-gold" onclick="showAddProductModal()">
                        <i class="fas fa-plus"></i> إضافة منتج
                    </button>
                </div>

                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>المنتج</th>
                                <th>القسم</th>
                                <th>السعر</th>
                                <th>الكمية</th>
                                <th>التاجر</th>
                                <th>التقييم</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${products.map(product => {
                                const merchant = users.find(u => u.id === product.merchantId);
                                return `
                                    <tr>
                                        <td>${product.name}</td>
                                        <td>${getCategoryName(product.category)}</td>
                                        <td style="color: var(--gold); font-weight: 700;">${product.price.toLocaleString()} دج</td>
                                        <td>
                                            <span class="${product.stock <= 0 ? 'out-of-stock' : product.stock < 5 ? 'low-stock' : 'in-stock'}" 
                                                  style="padding: 3px 10px; border-radius: 20px; font-size: 12px;">
                                                ${product.stock}
                                            </span>
                                        </td>
                                        <td>${merchant ? merchant.name : 'منتج عام'}</td>
                                        <td>${product.rating} ⭐</td>
                                        <td>
                                            <button class="btn-outline-gold" onclick="editProduct(${product.id})" style="padding: 5px 10px; margin-left: 5px;">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn-outline-gold" onclick="deleteProduct(${product.id})" style="padding: 5px 10px; background: #f87171; color: white;">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showDashboardMerchants(container) {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            const pendingMerchants = users.filter(u => u.role === 'merchant_pending');
            const approvedMerchants = users.filter(u => u.role === 'merchant_approved');

            container.innerHTML = `
                <h3 style="margin-bottom: 30px; color: var(--gold);">إدارة التجار</h3>
                
                <h4 style="margin: 20px 0; color: var(--gold);">طلبات الانضمام (${pendingMerchants.length})</h4>
                ${pendingMerchants.map(merchant => `
                    <div style="background: var(--glass); border: 1px solid var(--gold); border-radius: 20px; padding: 20px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h5 style="color: var(--gold);">${merchant.name}</h5>
                                <p><i class="fas fa-envelope" style="color: var(--gold);"></i> ${merchant.email}</p>
                                <p><i class="fas fa-store" style="color: var(--gold);"></i> المستوى: ${merchant.merchantLevel} | ${merchant.merchantDesc}</p>
                            </div>
                            <div>
                                <button class="btn-gold" onclick="approveMerchant(${merchant.id})" style="margin-left: 10px;">
                                    <i class="fas fa-check"></i> موافقة
                                </button>
                                <button class="btn-outline-gold" onclick="rejectMerchant(${merchant.id})">
                                    <i class="fas fa-times"></i> رفض
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('')}

                <h4 style="margin: 30px 0 20px; color: var(--gold);">التجار المعتمدون (${approvedMerchants.length})</h4>
                ${approvedMerchants.map(merchant => `
                    <div style="background: var(--glass); border: 1px solid var(--gold); border-radius: 20px; padding: 20px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h5 style="color: var(--gold);">${merchant.name} <i class="fas fa-check-circle" style="color: #4ade80;"></i></h5>
                                <p><i class="fas fa-envelope" style="color: var(--gold);"></i> ${merchant.email}</p>
                                <p><i class="fas fa-store" style="color: var(--gold);"></i> المستوى: ${merchant.merchantLevel}</p>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function approveMerchant(userId) {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            const user = users.find(u => u.id === userId);
            if (user) {
                user.role = 'merchant_approved';
                saveUsers();
                showNotification('تمت الموافقة على التاجر', 'success');
                openDashboard();
                switchDashboardTab('merchants');
            }
        }

        function rejectMerchant(userId) {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            const user = users.find(u => u.id === userId);
            if (user) {
                user.role = 'customer';
                saveUsers();
                showNotification('تم رفض طلب التاجر', 'info');
                openDashboard();
                switchDashboardTab('merchants');
            }
        }

        // ========== إدارة المنتجات (مع صلاحيات) ==========
        function showAddProductModal() {
            if (!currentUser) {
                showNotification('يجب تسجيل الدخول أولاً', 'warning');
                openLoginModal();
                return;
            }

            if (currentUser.role === 'merchant_approved') {
                document.getElementById('modalTitle').textContent = 'إضافة منتج جديد (خاص بك)';
                
                // تعيين التاجر تلقائياً لمنتجاته
                const merchantSelect = document.getElementById('productMerchant');
                merchantSelect.innerHTML = `<option value="${currentUser.id}">${currentUser.name}</option>`;
                merchantSelect.disabled = true;
                
                showNotification('يمكنك إضافة منتج خاص بك فقط', 'info');
            } 
            else if (currentUser.role === 'admin') {
                document.getElementById('modalTitle').textContent = 'إضافة منتج جديد';
                
                // تعبئة قائمة التجار للمدير
                const merchantSelect = document.getElementById('productMerchant');
                merchantSelect.innerHTML = '<option value="">منتج عام</option>';
                users.filter(u => u.role === 'merchant_approved').forEach(m => {
                    merchantSelect.innerHTML += `<option value="${m.id}">${m.name} (مستوى ${m.merchantLevel})</option>`;
                });
                merchantSelect.disabled = false;
            } 
            else {
                showNotification('فقط المدير والتجار يمكنهم إضافة منتجات', 'error');
                return;
            }
            
            document.getElementById('productName').value = '';
            document.getElementById('productCategory').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productStock').value = '';
            document.getElementById('editingProductId').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('productImagesData').value = '';

            document.getElementById('productModal').style.display = 'flex';
        }

        function handleImageUpload(event) {
            const files = event.target.files;
            const preview = document.getElementById('imagePreview');
            const imagesData = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();

                reader.onload = function(e) {
                    preview.innerHTML += `<img src="${e.target.result}" class="preview-image">`;
                    imagesData.push(e.target.result);
                    document.getElementById('productImagesData').value = JSON.stringify(imagesData);
                };

                reader.readAsDataURL(file);
            }
        }

        function saveProduct() {
            if (!currentUser) {
                showNotification('يجب تسجيل الدخول أولاً', 'error');
                return;
            }

            const name = document.getElementById('productName').value;
            const category = document.getElementById('productCategory').value;
            const price = parseInt(document.getElementById('productPrice').value);
            const stock = parseInt(document.getElementById('productStock').value);
            const editingId = document.getElementById('editingProductId').value;
            const imagesData = document.getElementById('productImagesData').value;

            if (!name || !category || !price || !stock) {
                showNotification('الرجاء ملء جميع الحقول', 'error');
                return;
            }

            // تحديد merchantId حسب الدور
            let merchantId = null;
            if (currentUser.role === 'merchant_approved') {
                merchantId = currentUser.id;
            } else if (currentUser.role === 'admin') {
                merchantId = document.getElementById('productMerchant').value || null;
            }

            const images = imagesData ? JSON.parse(imagesData) : [];

            if (editingId) {
                const index = products.findIndex(p => p.id == editingId);
                if (index !== -1) {
                    // التحقق من صلاحية التعديل
                    if (currentUser.role === 'merchant_approved' && products[index].merchantId !== currentUser.id) {
                        showNotification('لا يمكنك تعديل منتجات الآخرين', 'error');
                        return;
                    }
                    
                    products[index] = {
                        ...products[index],
                        name,
                        category,
                        price,
                        stock,
                        merchantId,
                        images: images.length > 0 ? images : products[index].images
                    };
                }
                showNotification('تم تعديل المنتج', 'success');
            } else {
                const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                products.push({
                    id: newId,
                    name,
                    category,
                    price,
                    stock,
                    rating: 4.5,
                    images: images.length > 0 ? images : ["https://via.placeholder.com/300/2c5e4f/ffffff?text=نكهة+وجمال"],
                    merchantId
                });
                showNotification('تم إضافة المنتج', 'success');
            }

            saveProducts();
            displayProducts();
            closeModal('productModal');
            
            // تحديث لوحة التاجر إذا كان تاجر
            if (currentUser.role === 'merchant_approved') {
                showMerchantPanel();
            }
            
            analyticsManager.trackEvent('productAdded', { name, merchantId });
        }

        function editProduct(id) {
            if (!currentUser) {
                showNotification('يجب تسجيل الدخول أولاً', 'error');
                return;
            }

            const product = products.find(p => p.id === id);
            if (!product) return;

            // التحقق من صلاحية التعديل
            if (currentUser.role === 'merchant_approved' && product.merchantId !== currentUser.id) {
                showNotification('لا يمكنك تعديل منتجات الآخرين', 'error');
                return;
            }

            document.getElementById('modalTitle').textContent = 'تعديل المنتج';
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productStock').value = product.stock;
            document.getElementById('editingProductId').value = id;

            // تعطيل/تمكين حقل التاجر حسب الدور
            const merchantSelect = document.getElementById('productMerchant');
            if (currentUser.role === 'merchant_approved') {
                merchantSelect.innerHTML = `<option value="${currentUser.id}">${currentUser.name}</option>`;
                merchantSelect.disabled = true;
            } else if (currentUser.role === 'admin') {
                merchantSelect.innerHTML = '<option value="">منتج عام</option>';
                users.filter(u => u.role === 'merchant_approved').forEach(m => {
                    merchantSelect.innerHTML += `<option value="${m.id}" ${product.merchantId === m.id ? 'selected' : ''}>${m.name}</option>`;
                });
                merchantSelect.disabled = false;
            }

            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            if (product.images) {
                product.images.forEach(img => {
                    preview.innerHTML += `<img src="${img}" class="preview-image">`;
                });
            }

            document.getElementById('productModal').style.display = 'flex';
        }

        function deleteProduct(id) {
            if (!currentUser) {
                showNotification('يجب تسجيل الدخول أولاً', 'error');
                return;
            }

            const product = products.find(p => p.id === id);
            
            // التحقق من صلاحية الحذف
            if (currentUser.role === 'merchant_approved' && product.merchantId !== currentUser.id) {
                showNotification('لا يمكنك حذف منتجات الآخرين', 'error');
                return;
            }
            
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                products = products.filter(p => p.id !== id);
                saveProducts();
                displayProducts();
                showNotification('تم حذف المنتج', 'info');
                
                // تحديث لوحة التاجر إذا كان تاجر
                if (currentUser.role === 'merchant_approved') {
                    showMerchantPanel();
                }
                
                analyticsManager.trackEvent('productDeleted', { productId: id });
            }
        }

        // ========== دوال إضافية ==========
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ========== التهيئة ==========
        window.onload = function() {
            loadProducts();
            loadCart();

            const savedUser = localStorage.getItem('current_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateUIBasedOnRole();
            }

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                isDarkMode = savedTheme === 'dark';
                document.body.classList.toggle('light-mode', !isDarkMode);
                const toggle = document.getElementById('themeToggle');
                toggle.innerHTML = isDarkMode ? 
                    '<i class="fas fa-moon"></i><span>ليلي</span>' : 
                    '<i class="fas fa-sun"></i><span>نهاري</span>';
            }

            setTimeout(() => {
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                }, 500);
            }, 1000);

            analyticsManager.trackPageView('home');
        };

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>
